<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget — Transactions</title>

  <!-- Google Identity Services (OAuth token) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111826;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --line:#233044;
      --accent:#7c5cff;
      --good:#2dd4bf;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 8px 28px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 15%, rgba(45,212,191,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1050px; margin: 0 auto; padding: 28px 18px 60px; }
    header{ display:flex; gap:14px; align-items:flex-end; justify-content:space-between; margin-bottom:18px; }
    .title{ display:flex; flex-direction:column; gap:4px; }
    .title h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .title p{ margin:0; color:var(--muted); font-size: 13px; }

    .pill{
      font-family:var(--mono);
      font-size: 12px;
      padding: 7px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 999px;
      color: var(--muted);
      white-space:nowrap;
    }

    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 16px; align-items:start; }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      header{ align-items:flex-start; flex-direction:column; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px;
      background: rgba(255,255,255,.02);
      border-bottom: 1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .card .hd h2{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .card .hd .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .card .bd{ padding: 16px; }
    .row{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .field{ grid-column: span 6; } .field.sm{ grid-column: span 4; } .field.xs{ grid-column: span 3; } .field.full{ grid-column: 1 / -1; }
    @media (max-width: 700px){ .field, .field.sm, .field.xs{ grid-column: 1 / -1; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 0 0 6px; }

    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      transition: border-color .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(124,92,255,.65);
      box-shadow: 0 0 0 3px rgba(124,92,255,.15);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .btn{
      cursor:pointer;
      border:1px solid rgba(124,92,255,.55);
      background: linear-gradient(180deg, rgba(124,92,255,.25), rgba(124,92,255,.12));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      letter-spacing:.2px;
    }
    .btn.ghost{
      border-color: var(--line);
      background: rgba(255,255,255,.02);
      font-weight:600;
      color: var(--muted);
    }
    .btn.bad{
      border-color: rgba(251,113,133,.55);
      background: linear-gradient(180deg, rgba(251,113,133,.22), rgba(251,113,133,.08));
    }

    .toast{
      margin-top: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--muted);
      display:none;
    }
    .toast.show{ display:block; }
    .toast.ok{ border-color: rgba(45,212,191,.45); color: rgba(45,212,191,.95); }
    .toast.err{ border-color: rgba(251,113,133,.45); color: rgba(251,113,133,.95); }
    .toast.warn{ border-color: rgba(251,191,36,.45); color: rgba(251,191,36,.95); }

    table{ width:100%; border-collapse:collapse; font-size: 13px; }
    th, td{ border-bottom: 1px solid var(--line); padding: 10px 8px; text-align:left; vertical-align:top; }
    th{ color: var(--muted); font-weight:600; font-size: 12px; }
    tr:hover td{ background: rgba(255,255,255,.01); }

    .mono{ font-family: var(--mono); }
    .rightAlign{ text-align:right; }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; color: var(--muted); }

    .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; padding: 0 16px 16px; }
    .kpi{
      flex: 1 1 140px;
      min-width: 140px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .kpi .k{ font-size: 11px; color: var(--muted); }
    .kpi .v{ font-size: 16px; font-weight: 700; margin-top: 4px; }

    footer{ margin-top: 14px; color: var(--muted); font-size: 12px; text-align:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Budget — Transaction Entry</h1>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <span class="pill" id="pillState">Not signed in</span>
        <button class="btn ghost" id="btnAuth" type="button">Sign in</button>
        <button class="btn bad" id="btnSignOut" type="button">Sign out</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <h2>Add transaction</h2>
          <div class="right">
            <button class="btn ghost" id="btnLoadLists" type="button">Reload lists</button>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi"><div class="k">Queued</div><div class="v mono" id="kpiQueued">—</div></div>
          <div class="kpi"><div class="k">Last status</div><div class="v mono" id="kpiLast">—</div></div>
          <div class="kpi"><div class="k">Recent loaded</div><div class="v mono" id="kpiRecent">—</div></div>
        </div>

        <div class="bd">
          <form id="txForm" autocomplete="off">
            <div class="row">
              <div class="field sm">
                <label for="date">Date</label>
                <input id="date" name="date" type="date" required />
              </div>
              <div class="field sm">
                <label for="person">Person</label>
                <select id="person" name="person" required></select>
              </div>
              <div class="field sm">
                <label for="type">Type</label>
                <select id="type" name="type" required></select>
              </div>
              <div class="field sm">
                <label for="category">Category</label>
                <select id="category" name="category" required></select>
              </div>
              <div class="field sm">
                <label for="amount">Amount</label>
                <input id="amount" name="amount" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00" required />
              </div>
              <div class="field sm">
                <label for="payment">Payment method</label>
                <select id="payment" name="payment" required></select>
              </div>
              <div class="field sm">
                <label for="isFixed">Is fixed?</label>
                <select id="isFixed" name="isFixed">
                  <option value="No">No</option>
                  <option value="Yes">Yes</option>
                </select>
              </div>
              <div class="field sm">
                <label for="account">Account (optional)</label>
                <select id="account" name="account">
                  <option value="—">—</option>
                </select>
              </div>
              <div class="field full">
                <label for="desc">Description / Merchant</label>
                <input id="desc" name="desc" type="text" placeholder="e.g., Swiggy, Petrol pump, Rent, Salary…" />
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;">
              <button class="btn" type="submit">Add to sheet</button>
              <button class="btn ghost" id="btnClear" type="button">Clear</button>
            </div>

            <div class="toast" id="toast"></div>
          </form>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2>Recent transactions</h2>
          <div class="right">
            <button class="btn ghost" id="btnRefreshRecent" type="button">Refresh</button>
          </div>
        </div>

        <div class="bd" style="padding:0;">
          <div style="padding: 12px 16px; border-bottom: 1px solid var(--line);" class="small">
            Shows the last <span class="mono" id="recentN">20</span> rows.
          </div>
          <div style="overflow:auto; max-height: 560px;">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Person</th><th>Type</th><th>Category</th><th class="rightAlign">Amount</th><th>Pay</th>
                </tr>
              </thead>
              <tbody id="recentBody">
                <tr><td colspan="6" class="muted">No data yet.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
/** =========================================================
 *  CONFIG — replace if needed
 *  ========================================================= */
const GOOGLE_OAUTH_CLIENT_ID = "749192975514-5q56jrs4clv8dmrmciirjm2d9ejdlpn0.apps.googleusercontent.com";
const GOOGLE_API_KEY         = "AIzaSyCRKqhI6gB-oYdRNcycMkVf6-xCVMLHMD0"; // optional but recommended

const SPREADSHEET_ID = "14HIgGbjyEsmoT3zA0SI10OFbyW7wlNc453ZowbXktVU";
const TX_SHEET   = "Transactions";
const LISTS_SHEET = "Lists";
const LISTS_START_ROW = 2;

const RECENT_N = 20;

/** =========================================================
 *  Static category lists (separators in UI)
 *  ========================================================= */
const STATIC = {
  categoriesIncome: ["Salary (Me)","Salary (Spouse)","Bonus","Side Income","Interest/Dividends","Refunds/Other"],
  categoriesExpense: [
    "Rent / Housing","Grocery","Food (Dining)","Food (Delivery)","Petrol / Fuel",
    "Transport (Cab/Bus/Train)","Bills (Electricity/Water/Gas/Internet/Phone)",
    "Hospital / Medical","Insurance","EMI / Loans","Entertainment","Shopping","Subscriptions",
    "Cigarettes / Drinks","Personal Care","Gifts/Donations","Travel","Education","Kids/Family",
    "Savings/Investments","Miscellaneous / Buffer"
  ],
};

const SHEETS_API_BASE = "https://sheets.googleapis.com/v4/spreadsheets";

const $ = (id) => document.getElementById(id);

function toast(msg, kind=""){
  const el = $("toast");
  el.className = "toast show" + (kind ? " " + kind : "");
  el.textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ el.className = "toast"; }, 6500);
}

function setPill(text, ok=false){
  const el = $("pillState");
  el.textContent = text;
  el.style.borderColor = ok ? "rgba(45,212,191,.45)" : "rgba(251,113,133,.45)";
  el.style.color = ok ? "rgba(45,212,191,.95)" : "rgba(251,113,133,.95)";
}

function todayISO(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

function fillSelect(selectEl, values){
  selectEl.innerHTML = "";
  for (const v of values){
    const opt = document.createElement("option");
    if (typeof v === "string"){
      opt.value = v; opt.textContent = v;
    } else {
      opt.value = "";
      opt.textContent = v.label ?? "";
      opt.disabled = true;
    }
    selectEl.appendChild(opt);
  }
}

function buildCategoryList(income, expense){
  return [{label:"--- Income ---"}, ...income, {label:"--- Expenses ---"}, ...expense];
}

function setFormEnabled(enabled){
  const ids = ["date","person","type","category","amount","payment","isFixed","account","desc"];
  for (const id of ids){
    const el = $(id);
    if (el) el.disabled = !enabled;
  }
  const submitBtn = document.querySelector('#txForm button[type="submit"]');
  if (submitBtn) submitBtn.disabled = !enabled;
}

/** =========================================================
 *  Amount parsing: "₹98,000" -> 98000
 *  ========================================================= */
function parseAmount(v){
  if (typeof v === "number") return isFinite(v) ? v : 0;
  let s = String(v ?? "").trim();
  if (!s) return 0;

  // Keep digits, comma, dot, minus. Remove currency symbols and spaces.
  s = s.replace(/[^\d.,-]/g, "");

  // Remove thousand separators (commas)
  if (s.includes(",") && s.includes(".")){
    s = s.replace(/,/g, "");
  } else if (s.includes(",") && !s.includes(".")){
    s = s.replace(/,/g, "");
  }

  const n = Number(s);
  return isFinite(n) ? n : 0;
}

/** =========================================================
 *  Year/Month from ISO date (yyyy-mm-dd)
 *  ========================================================= */
function ymFromISODate(isoDate){
  const d = new Date(`${isoDate}T00:00:00`);
  if (isNaN(d.getTime())) throw new Error("Invalid date: " + isoDate);
  return { year: d.getFullYear(), month: d.getMonth() + 1 };
}

/** =========================================================
 *  OAuth (Google Identity Services)
 *  ========================================================= */
let tokenClient = null;
let accessToken = null;

function initAuth(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_OAUTH_CLIENT_ID,
    scope: "https://www.googleapis.com/auth/spreadsheets",
    callback: async (resp) => {
      if (resp && resp.access_token) {
        accessToken = resp.access_token;
        setPill("Signed in ✓", true);
        $("kpiLast").textContent = "auth OK";
        toast("Signed in ✓", "ok");

        // ✅ REQUIREMENT #1: auto-load lists + recent right after signing in
        try{
          setFormEnabled(false);
          $("kpiLast").textContent = "loading…";
          await loadLists();
          await loadRecent();
          setFormEnabled(true);

          // sensible defaults
          $("person").value = $("person").options[0]?.value || $("person").value;
          $("type").value = "Expense";
        }catch(e){
          console.error(e);
          toast(e.message, "err");
          $("kpiLast").textContent = "load FAIL";
          setFormEnabled(false);
        }
      } else {
        accessToken = null;
        setPill("Auth failed", false);
        $("kpiLast").textContent = "auth FAIL";
        toast("Auth failed.", "err");
        setFormEnabled(false);
      }
    }
  });
}

function signIn(){
  if (!tokenClient) throw new Error("Auth client not ready yet.");
  tokenClient.requestAccessToken({ prompt: "consent" });
}

function signOut(){
  accessToken = null;
  setPill("Not signed in", false);
  $("kpiLast").textContent = "signed out";
  toast("Signed out.", "ok");
  setFormEnabled(false);
}

function requireAuth(){
  if (!accessToken) throw new Error("Not signed in. Click Sign in.");
}

/** =========================================================
 *  Sheets API helpers
 *  ========================================================= */
function sheetsUrl(path, query = {}){
  const base = `${SHEETS_API_BASE}/${encodeURIComponent(SPREADSHEET_ID)}/${path}`;
  const u = new URL(base);
  if (GOOGLE_API_KEY) u.searchParams.set("key", GOOGLE_API_KEY);
  Object.entries(query).forEach(([k,v]) => u.searchParams.set(k, String(v)));
  return u.toString();
}

async function sheetsFetch(path, { method="GET", query={}, body=null } = {}){
  requireAuth();

  const res = await fetch(sheetsUrl(path, query), {
    method,
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: body ? JSON.stringify(body) : null
  });

  const data = await res.json().catch(() => null);

  if (!res.ok){
    const msg = data?.error?.message || `Sheets API error HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

/** =========================================================
 *  Lists (from Lists tab)
 *  Lists tab layout you showed:
 *  A = Months (JAN..DEC) ignore
 *  B = Person
 *  C = Type
 *  D = PaymentMethod
 *  E = Yes/No ignore
 *  F = Frequency ignore
 *  ========================================================= */
function parseLists(values){
  const rows = values || [];
  const col = (idx) => rows
    .map(r => (r[idx] ?? ""))
    .map(x => String(x).trim())
    .filter(Boolean);

  const uniq = (arr) => Array.from(new Set(arr));

  return {
    people: uniq(col(1)),         // B
    types: uniq(col(2)),          // C
    paymentMethods: uniq(col(3)), // D
    accounts: ["—"]
  };
}

async function loadLists(){
  const range = `${LISTS_SHEET}!A${LISTS_START_ROW}:F`;
  const out = await sheetsFetch(`values/${encodeURIComponent(range)}`, {
    query: { valueRenderOption: "FORMATTED_VALUE" }
  });

  const lists = parseLists(out.values);

  if (!lists.people.length || !lists.types.length || !lists.paymentMethods.length){
    throw new Error("Lists sheet missing people/types/paymentMethods values.");
  }

  fillSelect($("person"), lists.people);
  fillSelect($("type"), lists.types);
  fillSelect($("payment"), lists.paymentMethods);
  fillSelect($("category"), buildCategoryList(STATIC.categoriesIncome, STATIC.categoriesExpense));
  fillSelect($("account"), lists.accounts);

  $("kpiLast").textContent = "lists OK";
}

/** =========================================================
 *  Recent (Transactions tab)
 *  Your Transactions columns now:
 *  A Date | B Year | C Month | D Person | E Type | F Category | G Amount | H Payment | I IsFixed | J Description
 *  UI must IGNORE Year/Month but read/write them.
 *  ========================================================= */
function renderRecent(rows){
  const body = $("recentBody");
  if (!rows || !rows.length){
    body.innerHTML = `<tr><td colspan="6" class="muted">No data returned.</td></tr>`;
    return;
  }

  body.innerHTML = rows.map(r => {
    const amt = Number(r.amount || 0);
    return `
      <tr>
        <td class="mono">${escapeHtml(r.date || "")}</td>
        <td>${escapeHtml(r.person || "")}</td>
        <td>${escapeHtml(r.type || "")}</td>
        <td>${escapeHtml(r.category || "")}</td>
        <td class="rightAlign mono">${isFinite(amt) ? amt.toFixed(2) : "0.00"}</td>
        <td>${escapeHtml(r.paymentMethod || "")}</td>
      </tr>`;
  }).join("");
}

async function loadRecent(){
  // Read A:J from row 2 down
  const range = `${TX_SHEET}!A2:J`;
  const out = await sheetsFetch(`values/${encodeURIComponent(range)}`, {
    query: { valueRenderOption: "FORMATTED_VALUE" }
  });

  const rows = (out.values || []).map(r => ({
    date: r[0] || "",             // A Date (formatted like 1-Feb-2025)
    // r[1] Year (ignored in UI)
    // r[2] Month (ignored in UI)
    person: r[3] || "",           // D Person
    type: r[4] || "",             // E Type
    category: r[5] || "",         // F Category
    amount: parseAmount(r[6] || 0), // ✅ G Amount (fixes your "0" problem)
    paymentMethod: r[7] || "",    // H Payment
    isFixed: r[8] || "",          // I IsFixed
    description: r[9] || "",      // J Description
  }));

  const recent = rows.slice(-RECENT_N).reverse();
  renderRecent(recent);

  $("kpiRecent").textContent = String(recent.length);
  $("kpiLast").textContent = "recent OK";
  return recent;
}

/** =========================================================
 *  Append transaction (must follow sheet format)
 *  Insert: Date(yyyy-mm-dd) + Year + Month + Person + Type + Category + Amount(number) + Pay + IsFixed + Desc
 *  ========================================================= */
function buildPayload(){
  return {
    date: $("date").value,                 // yyyy-mm-dd
    person: $("person").value,
    type: $("type").value,
    category: $("category").value,
    amount: Number($("amount").value || 0),
    paymentMethod: $("payment").value,
    isFixed: $("isFixed").value || "No",
    description: $("desc").value || "",
  };
}

function validate(p){
  if (!p.date) return "Date is required.";
  if (!p.person) return "Person is required.";
  if (!p.type) return "Type is required.";
  if (!p.category) return "Category is required.";
  if (!p.paymentMethod) return "Payment method is required.";
  if (!Number.isFinite(p.amount) || p.amount <= 0) return "Amount must be > 0.";
  return null;
}

function clearForm(){
  $("amount").value = "";
  $("desc").value = "";
  $("isFixed").value = "No";
  $("type").value = "Expense";
  $("date").value = todayISO();
}

async function appendTx(p){
  const { year, month } = ymFromISODate(p.date);

  const row = [
    String(p.date),               // A Date (yyyy-mm-dd) -> sheet formats to 1-Feb-2025
    Number(year),                 // B Year
    Number(month),                // C Month
    String(p.person),             // D Person
    String(p.type),               // E Type
    String(p.category),           // F Category
    Number(p.amount || 0),        // G Amount (no ₹, no commas)
    String(p.paymentMethod),      // H Payment Method
    String(p.isFixed || "No"),    // I Is Fixed?
    String(p.description || "")   // J Description
  ];

  const range = `${TX_SHEET}!A:J`;
  const path = `values/${encodeURIComponent(range)}:append`;

  await sheetsFetch(path, {
    method: "POST",
    query: {
      valueInputOption: "USER_ENTERED",
      insertDataOption: "INSERT_ROWS"
    },
    body: { values: [row] }
  });
}

/** =========================================================
 *  Boot
 *  ========================================================= */
window.addEventListener("DOMContentLoaded", async () => {
  $("date").value = todayISO();
  $("recentN").textContent = String(RECENT_N);
  $("kpiQueued").textContent = "—";

  setFormEnabled(false);
  setPill("Not signed in", false);
  $("kpiLast").textContent = "auth required";

  // Wait for GIS to load
  const waitForGsi = async () => {
    for (let i=0; i<70; i++){
      if (window.google?.accounts?.oauth2) return;
      await new Promise(r => setTimeout(r, 100));
    }
    throw new Error("Google auth library failed to load.");
  };

  try{
    await waitForGsi();
    initAuth();
  }catch(e){
    console.error(e);
    toast(e.message, "err");
    return;
  }

  $("btnAuth").addEventListener("click", () => {
    try{ signIn(); } catch(e){ toast(e.message, "err"); }
  });

  $("btnSignOut").addEventListener("click", () => {
    signOut();
  });

  $("btnLoadLists").addEventListener("click", async () => {
    try{
      $("kpiLast").textContent = "loading lists…";
      await loadLists();
      toast("Lists loaded.", "ok");
    }catch(e){
      toast(e.message, "err");
    }
  });

  $("btnRefreshRecent").addEventListener("click", async () => {
    try{
      $("kpiLast").textContent = "loading recent…";
      await loadRecent();
      toast("Recent refreshed.", "ok");
    }catch(e){
      toast(e.message, "err");
    }
  });

  $("btnClear").addEventListener("click", () => {
    clearForm();
    toast("Cleared.", "ok");
  });

  $("txForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    let p;
    try{
      requireAuth();
      p = buildPayload();
    }catch(ex){
      toast(ex.message, "err");
      return;
    }

    const err = validate(p);
    if (err){ toast(err, "err"); return; }

    try{
      $("kpiLast").textContent = "saving…";
      await appendTx(p);
      $("kpiLast").textContent = "saved ✓";
      toast("Saved to sheet ✓", "ok");
      clearForm();
      await loadRecent();
    }catch(ex){
      console.error(ex);
      $("kpiLast").textContent = "save FAIL";
      toast(ex.message, "err");
    }
  });
});
</script>
</body>
</html>
